# シフト管理システム 要件定義書

## 概要

小規模向けの軽量シフト管理システム。LINE Bot中心の自然言語操作と、保守性を重視したシンプルな設計を特徴とする。

---

## 技術スタック

### フロントエンド
- **Next.js 14** (Pages Router) - SSG/SSR対応
- **React** + TypeScript - 型安全なUI開発
- **独自ニューモーフィズムCSS** - TailwindCSS不使用
- **Lucide React** - アイコンライブラリ

### バックエンド
- **Next.js API Routes** - サーバーレス関数
- **JSONファイルベースDB** - 初期は軽量運用、PostgreSQL移行準備済み
- **Puppeteer** - PDF生成
- **node-cron** - スケジュールジョブ

### 外部連携・機能
- **LINE Messaging API** - メンション対応チャットボット
- **自然言語処理（独自実装）** - 簡易意図解析
- **Vercel** - サーバーレスデプロイメント

### データストレージ
- **JSONファイル** - 開発・小規模運用
- **ファイルシステム** - PDF/画像キャッシュ

---

## 主要機能一覧

| 大分類 | 機能名 | 詳細機能 | 実装方式 | 優先度 | 開発フェーズ |
|--------|--------|----------|----------|--------|-------------|
| **シフト表示** | シフト表画面 | 日別シフト表示、スタッフ配置確認 | Next.js SSG | 高 | Phase 1 |
| | 月間表示 | 月間カレンダー形式でのシフト俯瞰 | Next.js SSG | 中 | Phase 2 |
| | PDF出力 | 印刷最適化シフト表PDF生成 | Puppeteer | 高 | Phase 1 |
| | 画像出力 | スマホ保存用画像ファイル生成 | Puppeteer | 中 | Phase 1 |
| **LINE Bot** | 自然言語シフト提出 | @メンション + 自然言語でシフト希望提出 | LINE Webhook + NLP | 高 | Phase 2 |
| | シフト確認 | 「明日のシフト教えて」等の自然な問い合わせ | LINE Webhook | 高 | Phase 2 |
| | 変更依頼 | 「代わってもらえますか」等の代替依頼 | LINE Webhook | 中 | Phase 2 |
| | PDF配信 | LINE経由でのPDFダウンロードリンク送信 | LINE Push API | 中 | Phase 2 |
| **管理機能** | 仮シフト生成 | 希望を元にした自動仮シフト作成 | アルゴリズム | 高 | Phase 2 |
| | 人手不足検知 | 時間帯別人員不足の自動検出・警告 | 計算ロジック | 高 | Phase 2 |
| | シフト確定 | 仮シフトから確定シフトへの変更 | LINE通知連携 | 高 | Phase 2 |
| | 手動調整 | LINE経由での管理者による個別調整 | LINE Webhook | 中 | Phase 2 |
| **共有事項** | 重要事項管理 | 設備故障、スタッフ状況等の共有 | JSONベース | 高 | Phase 1 |
| | 優先度管理 | Urgent/High/Medium/Lowでの分類 | フラグ管理 | 中 | Phase 1 |
| | 自動表示 | シフト表と連動した共有事項表示 | 条件分岐 | 高 | Phase 1 |
| **通知システム** | 日次シフト通知 | 翌日シフト者への自動LINE通知 | Cron + LINE Push | 中 | Phase 2 |
| | 提出催促 | 未提出者への月末自動催促 | Cron + LINE Push | 中 | Phase 2 |
| | 確定通知 | シフト確定時の全員通知 | LINE Push API | 高 | Phase 2 |
| **システム管理** | 自動バックアップ | 日次自動データバックアップ | Cron + File操作 | 高 | Phase 1 |
| | データアーカイブ | 古いデータの月次アーカイブ | Cron + File操作 | 中 | Phase 3 |
| | ヘルスチェック | システム状態監視API | Next.js API | 中 | Phase 3 |

---

## 画面一覧

| 画面カテゴリ | 画面名 | URL | 主要機能 | アクセス権限 | 優先度 |
|-------------|--------|-----|----------|-------------|--------|
| **メイン表示** | 日別シフト表 | `/[date]` | シフト表示、共有事項表示、アクション | 全ユーザー | 高 |
| | 月間シフト表 | `/month/[month]` | 月間カレンダー形式表示 | 全ユーザー | 中 |
| | 今日のシフト | `/today` | 当日特化表示、日次メッセージ | 全ユーザー | 高 |
| **管理画面** | 管理ダッシュボード | `/admin` | 管理者専用機能一覧 | 管理者のみ | 中 |
| | ユーザー管理 | `/admin/users` | スタッフ登録・権限管理 | 管理者のみ | 中 |
| | システム設定 | `/admin/settings` | 基本設定、LINE設定 | 管理者のみ | 中 |
| **API** | PDF生成 | `/api/pdf/[date]` | シフト表PDF出力 | APIキー認証 | 高 |
| | 画像生成 | `/api/image/[date]` | シフト表画像出力 | APIキー認証 | 中 |
| | LINE Webhook | `/api/webhook` | LINE Bot メッセージ処理 | LINE署名認証 | 高 |
| | データAPI | `/api/shift/[date]` | シフトデータJSON出力 | 基本認証 | 低 |
| **その他** | QRコード | `/qr/[date]` | アクセス用QRコード生成 | パブリック | 中 |
| | ヘルスチェック | `/api/health` | システム状態確認 | パブリック | 中 |

---

## データ設計方針

### JSONファイル構造
```typescript
interface DatabaseSchema {
  users: Record<string, User>;           // LINEユーザー管理
  positions: Position[];                 // ポジション定義
  shifts: Record<string, Shift[]>;       // 日別シフトデータ
  shiftRequests: Record<string, ShiftRequest>; // 月別希望
  sharedNotices: Notice[];               // 共有事項
  dailyMessages: Record<string, Message[]>; // 日次メッセージ
  settings: SystemSettings;              // システム設定
  metadata: DatabaseMetadata;            // メタ情報
}
```

### PostgreSQL移行戦略
- Phase 3でデータ量増大時に移行
- JSONスキーマ → PostgreSQLテーブル自動変換
- 移行スクリプト事前準備
- ダウンタイム最小化

---

## LINE Bot 仕様

### 対応コマンド形式

#### 一般スタッフ用（自然言語）
```
@シフトボット 明日のシフト教えて
@シフトボット 来週火曜日代わってもらえますか
@シフトボット シフト表のPDF欲しい
@シフトボット お知らせ教えて
```

#### 管理者用（自然言語）
```
@シフトボット 来月の仮シフト見せて
@シフトボット 人手不足の詳細教えて
@シフトボット 1月20日、田中さんを洗い場の9時から17時に配置
@シフトボット 来月のシフト確定して
@シフトボット お盆休み期間を8月11日から15日まで設定
```

### 自然言語処理仕様
- **正規表現ベース**: シンプルなパターンマッチング
- **意図分類**: 10種類程度の基本意図
- **パラメータ抽出**: 日付、時間、ユーザー名の抽出
- **信頼度判定**: マッチング精度による応答制御

---

## 開発フェーズ詳細

### Phase 1: Core MVP（3-4週間）
**目標**: 基本的なシフト表示・編集・PDF出力

| 週 | タスク | 学習ポイント | 成果物 |
|----|--------|-------------|--------|
| 1 | Next.js + ニューモーフィズムUI構築 | Next.js Pages Router、独自CSS設計 | 基本レイアウト |
| 2 | JSONデータベース + シフト表示 | ファイルI/O、データ構造設計 | シフト表示画面 |
| 3 | PDF生成 + 共有事項管理 | Puppeteer、HTML→PDF変換 | PDF出力機能 |
| 4 | 管理画面 + テスト・調整 | CRUD操作、エラーハンドリング | 動作するMVP |

### Phase 2: LINE Bot連携（3-4週間）
**目標**: LINE経由でのシフト提出・確認・通知

| 週 | タスク | 学習ポイント | 成果物 |
|----|--------|-------------|--------|
| 1 | LINE Webhook + 署名検証 | LINE Messaging API、Webhook処理 | Bot基盤 |
| 2 | 自然言語処理 + 意図解析 | 正規表現、パターンマッチング | NLP エンジン |
| 3 | シフト提出・確認機能 | データ連携、状態管理 | Bot機能 |
| 4 | 通知システム + スケジュール | Cron、Push通知 | 自動化機能 |

### Phase 3: 高度機能（2-3週間）
**目標**: 運用最適化・スケーラビリティ対応

| 週 | タスク | 学習ポイント | 成果物 |
|----|--------|-------------|--------|
| 1 | PostgreSQL移行準備 | DB設計、マイグレーション | 移行スクリプト |
| 2 | パフォーマンス最適化 | キャッシング、最適化技術 | 高速化 |
| 3 | 監視・ログ・セキュリティ | 監視設計、セキュリティ対策 | 本番対応 |

---

## 非機能要件

### パフォーマンス
- **ページ表示速度**: 2秒以内（初回アクセス）
- **PDF生成時間**: 5秒以内
- **LINE Bot応答**: 3秒以内
- **同時接続数**: 50人程度まで対応

### セキュリティ
- **LINE署名検証**: 必須
- **入力値サニタイゼーション**: 全入力に対して実施
- **権限管理**: 管理者/一般スタッフの分離
- **データバックアップ**: 日次自動実行

### 運用性
- **稼働率**: 99%以上（Vercel標準）
- **バックアップ**: 30日間保持
- **ログ管理**: エラー・アクセスログ
- **監視**: ヘルスチェックAPI

### スケーラビリティ
- **ユーザー数**: 初期10-20名 → 最大100名
- **データ量**: JSON → PostgreSQL移行で対応
- **機能拡張**: モジュラー設計で追加機能対応

---

## 成功指標（KPI）

### 技術指標
- **開発速度**: 予定通りのフェーズ完了
- **バグ率**: 重大バグ月1件以下
- **応答速度**: 各機能の応答時間目標達成

### 利用指標
- **LINE Bot利用率**: スタッフの80%以上が月次利用
- **シフト提出率**: 期限内提出90%以上
- **PDF利用**: 週1回以上のPDF出力

### 運用指標
- **システム稼働率**: 99%以上
- **データ保全**: バックアップ失敗率1%以下

---

## リスク管理

### 技術リスク
| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| JSONファイル肥大化 | 高 | 中 | PostgreSQL移行計画 |
| LINE API制限 | 中 | 低 | レート制限対応 |
| PDF生成エラー | 中 | 中 | エラーハンドリング強化 |

### 運用リスク
| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| データ消失 | 高 | 低 | 自動バックアップ |
| 利用者の操作ミス | 中 | 高 | 直感的UI設計 |
| スケール不足 | 中 | 中 | 段階的スケールアップ |

**総開発期間**: 約2-3ヶ月
**運用開始目標**: Phase 2完了時点